<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>XAMKWÊ Echo — Dashboard</title>
    <link rel="manifest" href="/web/manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .wrap { max-width: 980px; margin: 0 auto; }
      h1 { font-size: 28px; margin: 0 0 8px 0; }
      .status { float: right; padding: 6px 10px; background: #10b981; color:#fff; border-radius: 6px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
      .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; }
      .big { font-size: 28px; font-weight: 700; }
      .muted { color: #6b7280; }
      .row { display:flex; gap:12px; align-items:center; margin:10px 0; }
      label { min-width: 130px; font-weight: 600; }
      input { padding: 10px 12px; border:1px solid #d1d5db; border-radius:6px; min-width: 160px; }
      button { padding: 10px 14px; border: 0; background: #2563eb; color: #fff; border-radius: 6px; cursor:pointer; }
      button.secondary { background:#6b7280; }
      .col { display:flex; flex-direction:column; gap:10px; }
      .log { min-height: 120px; border:1px dashed #cbd5e1; border-radius:8px; padding:10px; background:#f8fafc; overflow:auto; }
      .loop { margin-top:16px; }
      .loop h2 { margin: 0 0 8px 0; font-size:22px; }
      .loop .step { border-left:4px solid #e5e7eb; padding:10px 12px; margin:8px 0; }
      .loop .step b { display:inline-block; min-width: 220px; }
      .ok { color:#10b981; font-weight:600; }
      .warn { color:#f59e0b; font-weight:600; }
      .err { color:#ef4444; font-weight:600; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div>
          <h1>XAMKWÊ Echo))) <span class="muted">XKE 3748</span></h1>
        </div>
        <div id="online" class="status">online</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="big">Harvested</div>
          <div id="harvUnits" class="big">0.000000</div>
          <div id="harvUSD" class="muted">$0.00</div>
        </div>
        <div class="card">
          <div class="big">Harvest Rate</div>
          <div class="row"><label>eg.</label><input id="rate" placeholder="7.9" /></div>
          <div class="row"><button id="btnApplyRate" class="secondary">Apply</button><div id="rateMsg" class="muted">-</div></div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="card">
          <div class="big">Reinvest</div>
          <div class="row"><label>Amount:</label><input id="re_amt" placeholder="10" /></div>
          <div class="row"><button id="btnReinvest">Reinvest</button><div id="reinMsg" class="muted">-</div></div>
        </div>
        <div class="card">
          <div class="big">Payout</div>
          <div class="row"><label>Amount:</label><input id="pay_amt" placeholder="10" /></div>
          <div class="row"><button id="btnPayout" class="secondary">Queue Payout</button><div id="payMsg" class="muted">-</div></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px; display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div class="row"><label>Pool Total</label><div id="poolTotal" class="big">0.000000</div><button id="btnRefresh" class="secondary">Refresh</button></div>
        <div><a href="/web/accounting.html" title="Open accounting" style="padding:10px 14px; border-radius:6px; background:#10b981; color:#fff;">Open Accounting →</a></div>
        <div class="log" id="log"></div>
      </div>

      <div class="card loop">
        <h2>XKE’s End‑to‑End Operational Loop</h2>
        <div class="step"><b>1) Intake (Ingestion Layer)</b> <span id="stIntake" class="muted">—</span><br/>Nonstop capture of echoes (callbacks, wallet movements, blockchain). Stored immutably. No validation here.</div>
        <div class="step"><b>2) Processing (Harvesting Pipeline)</b> <span id="stProcessing" class="muted">—</span><br/>Validates, deduplicates, applies rules. Atomic posting.</div>
        <div class="step"><b>3) Ledger & Balances</b> <span id="stLedger" class="muted">—</span><br/>Double‑entry, event‑tied. Balances and reconciliation.</div>
        <div class="step"><b>4) Interest Rate & Pool Logic</b> <span id="stRates" class="muted">—</span><br/>Dynamic rate engine. Alerts on stale/missing.</div>
        <div class="step"><b>5) Payout Completion</b> <span id="stPayout" class="muted">—</span><br/>Settlements posted; reconciled; compliance gates.</div>
        <div class="step"><b>6) Reporting & Monitoring</b> <span id="stReport" class="muted">—</span><br/>Dashboards, alerts, integrity checks.</div>
        <div class="step"><b>7) Feedback Loop</b> <span id="stFeedback" class="muted">—</span><br/>Retries/DLQ; adjustments with reasons; circuit breakers.</div>
      </div>
    </div>

    <script>
      // PWA: register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/web/service-worker.js?v=3').then(reg => {
            if (reg && reg.update) { try { reg.update(); } catch(e){} }
          }).catch(()=>{});
        });
      }
      const $ = (id) => document.getElementById(id);
      function log(msg){ const el=$('log'); const t=new Date().toLocaleTimeString(); el.textContent += `[${t}] ${msg}\n`; el.scrollTop = el.scrollHeight; }

      async function getJSON(url, opts={}){ const r=await fetch(url, opts); return r.json(); }

      function parseNum(text){
        const v = parseFloat(String(text||'').replace(/[^0-9\.\-]/g,''));
        return isNaN(v) ? 0 : v;
      }

      function animateNumber(el, toValue, { duration=600, decimals=6 }={}){
        try{
          const from = parseNum(el.textContent);
          const to = Number(toValue||0);
          if (!isFinite(from) || !isFinite(to) || from === to){
            el.textContent = to.toFixed(decimals);
            return;
          }
          const start = performance.now();
          const ease = (t)=> t<.5 ? 2*t*t : -1+(4-2*t)*t;
          function tick(now){
            const p = Math.min(1, (now - start)/duration);
            const v = from + (to - from) * ease(p);
            el.textContent = Number(v).toFixed(decimals);
            if (p < 1) requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        } catch(e){ el.textContent = Number(toValue||0).toFixed(decimals); }
      }

      async function refreshTotals(){
        try {
          const t = await getJSON('/api/v1/pool/total');
          if (t && t.ok){
            animateNumber($('poolTotal'), Number(t.pool_total||0), {decimals:6});
            animateNumber($('harvUnits'), Number(t.pool_total||0), {decimals:6});
            const usdEl = $('harvUSD');
            const fromUsd = parseNum(usdEl.textContent);
            const toUsd = Number(t.pool_total||0);
            // animate USD separately with 2 decimals
            const start = performance.now();
            const duration = 600;
            const ease = (tt)=> tt<.5 ? 2*tt*tt : -1+(4-2*tt)*tt;
            function tick(now){
              const p = Math.min(1, (now - start)/duration);
              const v = fromUsd + (toUsd - fromUsd) * ease(p);
              usdEl.textContent = `$${Number(v).toLocaleString(undefined,{maximumFractionDigits:2})}`;
              if (p < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
          }
        } catch(e){ log('refreshTotals error: '+(e.message||e)); }
      }

      async function pingHarvest(inc){
        try {
          const url = inc? `/api/v1/pool/ping?inc=${encodeURIComponent(inc)}` : '/api/v1/pool/ping';
          const j = await getJSON(url);
          if (j && j.ok){ log(`ping applied=${j.applied} pool_total=${j.pool_total}`); await refreshTotals(); return; }
          log('ping error: '+(j && j.error));
        } catch(e){ log('ping error: '+(e.message||e)); }
      }

      async function doReinvest(){
        const v = parseFloat(($('re_amt').value||'0').trim());
        if (!v || v<=0){ $('reinMsg').textContent='Enter amount'; return; }
        try {
          const j = await getJSON('/api/v1/pool/add', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({amount_usdt:v, note:'reinvest'}) });
          if (j && j.ok){ $('reinMsg').textContent='OK'; await refreshTotals(); }
          else { $('reinMsg').textContent = (j && j.error)||'Error'; }
        } catch(e){ $('reinMsg').textContent = e.message||e; }
      }

      async function doPayout(){
        const v = parseFloat(($('pay_amt').value||'0').trim());
        if (!v || v<=0){ $('payMsg').textContent='Enter amount'; return; }
        try {
          const j = await getJSON('/api/v1/pool/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({amount_usdt:v, note:'payout_queue'}) });
          if (j && j.ok){ $('payMsg').textContent='Queued'; await refreshTotals(); }
          else { $('payMsg').textContent = (j && j.error)||'Error'; }
        } catch(e){ $('payMsg').textContent = e.message||e; }
      }

      $('btnRefresh').addEventListener('click', refreshTotals);
      $('btnApplyRate').addEventListener('click', ()=>{ const r=$('rate').value.trim(); if(r){ pingHarvest(r); $('rateMsg').textContent='Applied'; }});
      $('btnReinvest').addEventListener('click', doReinvest);
      $('btnPayout').addEventListener('click', doPayout);

      // initial
      refreshTotals();
      // auto-refresh totals every 9s (no ping to avoid 429 rate limits)
      setInterval(()=> { refreshTotals(); }, 9000);

      // Map API signals → loop statuses for clarity/flow
      async function refreshLoop(){
        try{
          const home = await getJSON('/api/v1/home');
          const status = await getJSON('/api/v1/status');
          const recon = await getJSON('/api/v1/reconcile/status');
          const metrics = await getJSON('/api/v1/metrics');
          // 1 Intake: consider OK when DB true and server online
          $('stIntake').textContent = (home && home.ok) ? 'Always on' : '—';
          $('stIntake').className = (home && home.ok) ? 'ok' : 'warn';
          // 2 Processing: pending_residual_events as activity proxy
          const pending = (status && typeof status.pending_residual_events==='number') ? status.pending_residual_events : 0;
          $('stProcessing').textContent = `Rules active • pending ${pending}`;
          $('stProcessing').className = 'ok';
          // 3 Ledger: pool_total numeric and db=true
          const pool = (status && typeof status.pool_total==='number') ? status.pool_total : 0;
          $('stLedger').textContent = `Consistent • pool ${pool.toFixed(6)}`;
          $('stLedger').className = 'ok';
          // 4 Rates: show usd_zar presence as proxy
          const hasRate = home && typeof home.usd_zar === 'number' && home.usd_zar>0;
          $('stRates').textContent = hasRate ? `Dynamic • USDZAR ${Number(home.usd_zar).toFixed(4)}` : 'Rate feed unavailable';
          $('stRates').className = hasRate ? 'ok' : 'warn';
          // 5 Payout: show last payout signals from metrics/status (simplified)
          $('stPayout').textContent = 'Ready • governed and auditable';
          $('stPayout').className = 'ok';
          // 6 Reporting: metrics endpoint ok
          $('stReport').textContent = (metrics && metrics.ok)? 'Healthy dashboards & alerts' : 'Metrics unavailable';
          $('stReport').className = (metrics && metrics.ok)? 'ok':'warn';
          // 7 Feedback: reconciler heartbeat
          const lastTs = recon && recon.last_ts ? recon.last_ts : null;
          $('stFeedback').textContent = lastTs ? `Active • last ${new Date(lastTs*1000).toLocaleTimeString()}` : 'Idle • awaiting activity';
          $('stFeedback').className = lastTs ? 'ok' : 'warn';
        } catch(e){ log('refreshLoop error: '+(e.message||e)); }
      }
      refreshLoop();
      setInterval(refreshLoop, 10000);
    </script>
  </body>
 </html>

